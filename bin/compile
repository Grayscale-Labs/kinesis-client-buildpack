#!/usr/bin/env ruby
# bin/compile <build-dir> <cache-dir>

require 'fileutils'
require 'open-uri'

MAVEN_URL = 'https://repo1.maven.org/maven2'
BUILD_DIR = "#{ARGV[0]}/jars"
CACHE_DIR = "#{ARGV[1]}/#{ENV['STACK']}"

# Grab from `mvn dependency:list`: https://maven.apache.org/plugins/maven-dependency-plugin/list-mojo.html
MAVEN_PACKAGES = [
  #[group id,                     artifact id,                    version,    MD5                               ],
  ['com.amazonaws',               'amazon-kinesis-client.jar',    '1.6.2',    'de8fd33f8c1b066f084d76e87d20c3c2']
  ['com.amazonaws',               'aws-java-sdk-cloudwatch.jar',  '1.10.61',  '47895b2b9ca0cc44c0c24c3c86911a34']
  ['com.amazonaws',               'aws-java-sdk-core.jar',        '1.10.61',  'd6b844a4e21a6be17d4d4895a0cb18ff']
  ['com.amazonaws',               'aws-java-sdk-dynamodb.jar',    '1.10.61',  'bf60264be94c51887cd70c7095a95574']
  ['com.amazonaws',               'aws-java-sdk-kinesis.jar',     '1.10.61',  'f31412629dac7ecea186cfd4378f8bd1']
  ['com.amazonaws',               'aws-java-sdk-kms.jar',         '1.10.61',  'ed9f1062cc8708e5f283bcd72df6a67e']
  ['com.amazonaws',               'aws-java-sdk-s3.jar',          '1.10.61',  '996572cbcced4b91aa5f0ee5a876171d']
  ['commons-codec',               'commons-codec.jar',            '1.6',      '5970f54883b4831b24b97f1125ba27e6']
  ['commons-lang',                'commons-lang.jar',             '2.6',      '4d5c1693079575b362edf41500630bbd']
  ['commons-logging',             'commons-logging.jar',          '1.1.3',    '92eb5aabc1b47287de53d45c086a435c']
  ['com.google.guava',            'guava.jar',                    '18.0',     '947641f6bb535b1d942d1bc387c45290']
  ['org.apache.httpcomponents',   'httpclient.jar',               '4.3.6',    '2d29a27bb6c6b44bc8a608a0e5d09735']
  ['org.apache.httpcomponents',   'httpcore.jar',                 '4.3.3',    'c26171852f9810cd3d2416604a387e71']
  ['com.fasterxml.jackson.core',  'jackson-annotations.jar',      '2.5.0',    'db2a8e900965c9618cac9abec038e3de']
  ['com.fasterxml.jackson.core',  'jackson-core.jar',             '2.5.3',    '5763215f9054614336ffa55d46a69e15']
  ['com.fasterxml.jackson.core',  'jackson-databind.jar',         '2.5.3',    'b04f954ff7a76091cd6a303ebba8c67d']
  ['joda-time',                   'joda-time.jar',                '2.8.1',    'c23002a0fac3455e92551e7f24500fa4']
  ['com.google.protobuf',         'protobuf-java.jar',            '2.6.1',    '5d30d643648298898b2b31d609c3e7f0']
]

def ensure_directory(path)
  unless File.directory?(path)
    FileUtils.mkdir_p(path)
  end
end

def jar_name(_, artifact_id, version, _)
  "#{artifact_id}-#{version}.jar"
end

def jar_url(group_id, artifact_id, version, md5)
  group_path = group_id.gsub(/\./, '/')
  jar_name = jar_name(group_id, artifact_id, version, md5)
  "#{MAVEN_URL}/#{group_path}/#{artifact_id}/#{version}/#{jar_name}"
end

def download_maven_jar(group_id, artifact_id, version, md5)
  jar_name = jar_name(group_id, artifact_id, version, md5)
  jar_url = jar_url(group_id, artifact_id, version, md5)
  cached_jar_file = File.join(CACHE_DIR, jar_name)
  File.open(cached_jar_file, 'wb') do |saved_file|
    open(jar_url, 'rb') do |read_file|
      saved_file.write(read_file.read)
    end
  end
end

def download_jars_if_needed
  MAVEN_PACKAGES.each do |jar|
    jar_name = jar_name(*jar)
    cached_jar_file = File.join(CACHE_DIR, jar_name)
    if !File.exist?(cached_jar_file)
      puts("Downloading '#{cached_jar_file}' from Maven...")
      download_maven_jar(*jar)
      # TODO: Validate md5sums after download
    end
  end
end

def copy_jars_to_app
  MAVEN_PACKAGES.each do |jar|
    jar_name = jar_name(*jar)
    cached_jar_file = File.join(CACHE_DIR, jar_name)
    app_jar_file = File.join(BUILD_DIR, jar_name)
    puts("Copying '#{jar_name}'...")
    FileUtils.cp(cached_jar_file, app_jar_file)
  end
end

ensure_directory(BUILD_DIR)
ensure_directory(CACHE_DIR)
download_jars_if_needed
copy_jars_to_app
